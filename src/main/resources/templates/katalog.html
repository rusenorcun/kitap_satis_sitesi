<!doctype html>
<html lang="tr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KitapYurdu ‚Ä¢ Katalog</title>
  <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css" />

  <!--  Katalog sayfasƒ± i√ßin k√º√ß√ºk, g√ºvenli ek stiller (DEBUG YOK) -->
  <style>
    /* Genel yerle≈üim */
    .katalogLayout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .katalogLayout{ grid-template-columns: 1fr; }
    }

    /* Sol panel */
    .panelCard{
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.05);
      overflow:hidden;
    }
    .panelCard__head{
      padding: 16px 16px 10px 16px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .panelCard__title{
      margin:0;
      font-size: 16px;
    }
    .panelCard__body{
      padding: 16px;
    }
    .filters .field{ margin-bottom: 12px; }
    .filters__actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    /* √úst meta */
    .katalogHead{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap:wrap;
      margin: 14px 0 16px 0;
    }
    .katalogTitle{
      margin:0;
      font-size: 22px;
    }
    .katalogSub{
      margin:6px 0 0 0;
    }
    .searchbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchbar .input{ min-width: 260px; }

    /*  Kitap grid fix (kitaplar g√∂r√ºn√ºr) */
    .productGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      align-items: stretch;
    }
    .productCard{
      display:flex;
      flex-direction:column;
      min-height: 350px;
      border-radius: 18px;
      overflow:hidden;
    }
    .productCard__img{
      display:block;
      height: 230px;
      overflow:hidden;
      border-radius: 0; /* kart zaten yuvarlak */
      position:relative;
      text-decoration:none;
    }
    .imgPh{
      height:100%;
      display:grid;
      place-items:center;
      font-size: 52px;
      background: rgba(0,0,0,.03);
    }
    .coverImg{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .productCard__body{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 14px 14px 12px 14px;
    }
    .productCard__title{
      font-weight: 700;
      line-height: 1.25;
      font-size: 15.5px;
      margin:0;
    }
    .productCard__meta{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
      font-size: 13px;
      opacity: .9;
    }
    .pillMini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      white-space:nowrap;
    }
    .productCard__foot{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .stockBadge{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      white-space: nowrap;
    }
    .stockBadge.is-ok{ background: rgba(0, 160, 90, .12); }
    .stockBadge.is-bad{ background: rgba(220, 60, 60, .12); }

    .chips{ padding: 10px 16px 0 16px; }
    .chip{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      margin: 0 6px 6px 0;
    }

    /* Pager */
    .pager{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 18px 0 0 0;
      flex-wrap:wrap;
    }
    .pager__nums{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      flex: 1;
    }
    .pager__num{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.08);
      text-decoration:none;
    }
    .pager__num.is-active{
      border-color: rgba(0,0,0,.25);
      font-weight: 700;
    }
  </style>
</head>

<body class="theme-light">
<header class="topbar">
  <div class="container topbar__inner">
    <a class="brand" th:href="@{/}" href="/">
      <span class="brand__mark">KY</span>
      <span class="brand__text">KitapYurdu</span>
    </a>

    <nav class="nav">
      <a class="nav__link" th:href="@{/}" href="/">Ana Sayfa</a>
      <a class="nav__link is-active" th:href="@{/katalog}" href="/katalog">Katalog</a>
      <a class="nav__link" th:href="@{/sepet}" href="/sepet">
        Sepet
        <span class="pill" th:text="${cartCount != null ? cartCount : 0}">0</span>
      </a>

      <!--  Profil sadece giri≈ü yapƒ±nca -->
      <a class="nav__link" th:href="@{/profil}" href="/profil" sec:authorize="isAuthenticated()">Profil</a>
    </nav>

    <div class="topbar__actions">
      <!--  Admin linki: sadece admin role -->
      <a class="btn btn--ghost" th:href="@{/admin}" href="/admin" sec:authorize="hasRole('ADMIN')">
        Admin
      </a>

      <!--  Giri≈ü yoksa: Giri≈ü butonu -->
      <a class="btn btn--ghost" th:href="@{/login}" href="/login" sec:authorize="isAnonymous()">
        Giri≈ü
      </a>

      <!--  Giri≈ü varsa: √áƒ±kƒ±≈ü butonu (POST /logout + CSRF) -->
      <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()" style="display:inline; margin:0;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn--ghost">√áƒ±kƒ±≈ü</button>
      </form>

      <button class="themeToggle" type="button" data-theme-toggle aria-pressed="false">
        <span class="themeIcon">‚òÄÔ∏è</span><span class="themeText">A√ßƒ±k</span>
      </button>
    </div>
  </div>
</header>

<main class="container">
  <!-- √úst ba≈ülƒ±k + arama -->
  <div class="katalogHead">
    <div>
      <h1 class="katalogTitle">Kitap Kataloƒüu</h1>
      <p class="katalogSub muted">Arama yap, filtrele ve kitaplarƒ± sepete ekle.</p>

      <div class="muted" style="margin-top:8px;">
        <span th:text="${total != null ? total : (books != null ? #lists.size(books) : 0)}">0</span>
        sonu√ß bulundu
        <span th:if="${q != null and !q.isBlank()}">
          ‚Ä¢ Aranan: <b th:text="${q}">q</b>
        </span>
      </div>
    </div>

    <form class="searchbar" th:action="@{/katalog}" method="get">
      <input class="input"
             type="search"
             name="q"
             placeholder="Kitap adƒ±, ISBN..."
             th:value="${q}"
             aria-label="Katalog arama" />
      <button class="btn btn--secondary" type="submit">Ara</button>
      <a class="btn btn--ghost" th:href="@{/katalog}" href="/katalog">Sƒ±fƒ±rla</a>
    </form>
  </div>

  <div class="katalogLayout">
    <!-- SOL: Filtre -->
    <aside class="panelCard">
      <div class="panelCard__head">
        <h2 class="panelCard__title">Filtreler</h2>
      </div>

      <div class="panelCard__body">
        <form class="filters" th:action="@{/katalog}" method="get">
          <input type="hidden" name="q" th:value="${q}" />

          <div class="field">
            <label class="label" for="cat">Kategori</label>
            <select class="select" id="cat" name="categoryId">
              <option value="">T√ºm√º</option>
              <option th:each="c : ${categories}"
                      th:value="${c.id}"
                      th:text="${c.name}"
                      th:selected="${selectedCategoryId != null and c.id == selectedCategoryId}">
                Kategori
              </option>
            </select>
          </div>

          <div class="field">
            <label class="label" for="pub">Yayƒ±nevi</label>
            <select class="select" id="pub" name="publisherId">
              <option value="">T√ºm√º</option>
              <option th:each="p : ${publishers}"
                      th:value="${p.id}"
                      th:text="${p.name}"
                      th:selected="${selectedPublisherId != null and p.id == selectedPublisherId}">
                Yayƒ±nevi
              </option>
            </select>
          </div>

          <div class="field">
            <label class="label" for="min">Fiyat (‚Ç∫)</label>
            <div class="grid2">
              <input class="input" id="min" type="number" step="0.01" name="minPrice" placeholder="Min"
                     th:value="${minPrice}" />
              <input class="input" type="number" step="0.01" name="maxPrice" placeholder="Max"
                     th:value="${maxPrice}" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="sort">Sƒ±ralama</label>
            <select class="select" id="sort" name="sort">
              <option value="popular" th:selected="${sort == null or sort == 'popular'}">Pop√ºler</option>
              <option value="price_asc" th:selected="${sort == 'price_asc'}">Fiyat (Artan)</option>
              <option value="price_desc" th:selected="${sort == 'price_desc'}">Fiyat (Azalan)</option>
              <option value="name_asc" th:selected="${sort == 'name_asc'}">ƒ∞sim (A ‚Üí Z)</option>
              <option value="name_desc" th:selected="${sort == 'name_desc'}">ƒ∞sim (Z ‚Üí A)</option>
              <option value="newest" th:selected="${sort == 'newest'}">En Yeni</option>
            </select>
          </div>

          <div class="field">
            <label class="label">Stok</label>
            <label class="check">
              <input type="checkbox" name="inStock" value="true" th:checked="${inStock == true}" />
              <span>Sadece stokta olanlar</span>
            </label>
          </div>

          <div class="filters__actions">
            <button class="btn btn--secondary" type="submit">Uygula</button>
            <a class="btn btn--ghost" th:href="@{/katalog(q=${q})}">Temizle</a>
          </div>
        </form>
      </div>

      <div class="chips" th:if="${activeFilters != null and !#lists.isEmpty(activeFilters)}">
        <span class="chip" th:each="f : ${activeFilters}" th:text="${f}">Filtre</span>
      </div>
    </aside>

    <!-- SAƒû: Liste -->
    <section>
      <!-- BO≈û DURUM -->
      <div class="empty" th:if="${books == null or #lists.isEmpty(books)}">
        <div class="empty__icon">üìö</div>
        <div class="empty__title">Sonu√ß bulunamadƒ±</div>
        <div class="empty__desc">Arama terimini deƒüi≈ütir veya filtreleri sƒ±fƒ±rla.</div>
        <a class="btn btn--secondary" th:href="@{/katalog}">Kataloƒüa d√∂n</a>
      </div>

      <!-- KART GRID -->
      <div class="productGrid" th:if="${books != null and !#lists.isEmpty(books)}">
        <article class="card productCard" th:each="b : ${books}">
          <a class="productCard__img" th:href="@{/kitap/{id}(id=${b.id})}" href="/kitap/1" aria-label="Kitap detayƒ±">
            <!--  Resim varsa g√∂ster -->
            <img class="coverImg"
                 th:if="${b.coverUrl != null and !b.coverUrl.isBlank()}"
                 th:src="${b.coverUrl}"
                 src="/img/cover-placeholder.png"
                 alt="Kapak"
                 loading="lazy" />

            <!--  Resim yoksa index'teki gibi ikon -->
            <div class="imgPh" th:if="${b.coverUrl == null or b.coverUrl.isBlank()}">üìò</div>

            <span class="badge badge--info" th:if="${b.createdAt != null}">Yeni</span>
          </a>

          <div class="productCard__body">
            <h3 class="productCard__title" th:text="${b.title}">Kitap Adƒ±</h3>

            <div class="productCard__meta">
              <span class="pillMini" th:if="${b.publisherName != null}" th:text="${b.publisherName}">Yayƒ±nevi</span>
              <span class="pillMini" th:if="${b.categoriesText != null and !b.categoriesText.isBlank()}"
                    th:text="${b.categoriesText}">Kategori</span>
              <span class="pillMini" th:if="${b.isbn != null and !b.isbn.isBlank()}"
                    th:text="'ISBN: ' + ${b.isbn}">ISBN</span>
            </div>

            <div class="productCard__foot">
              <div class="price">
                <span class="price__value"
                      th:text="${b.price != null ? #numbers.formatDecimal(b.price, 1, 'POINT', 2, 'POINT') : '-'}">0.00</span>
                <span class="price__cur">‚Ç∫</span>
              </div>

              <span class="stockBadge"
                    th:classappend="${b.stock != null and b.stock > 0} ? ' is-ok' : ' is-bad'"
                    th:text="${b.stock != null and b.stock > 0} ? ('Stok: ' + b.stock) : 'Stok yok'">
                Stok
              </span>
            </div>

            <form th:action="@{/sepet/ekle}" method="post" style="margin-top:8px;">
              <!--  CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <input type="hidden" name="bookId" th:value="${b.id}" />
              <input type="hidden" name="qty" value="1" />
              <button class="btn btn--secondary btn--block"
                      type="submit"
                      th:disabled="${b.stock == null or b.stock <= 0}">
                Sepete Ekle
              </button>
            </form>
          </div>
        </article>
      </div>

      <!-- SAYFALAMA -->
      <nav class="pager" th:if="${page != null and pageCount != null and pageCount > 1}">
        <a class="btn btn--ghost btn--sm"
           th:classappend="${page <= 1} ? ' is-disabled' : ''"
           th:href="@{/katalog(q=${q}, categoryId=${selectedCategoryId}, publisherId=${selectedPublisherId}, minPrice=${minPrice}, maxPrice=${maxPrice}, inStock=${inStock}, sort=${sort}, page=${page-1})}">
          ‚Üê √ñnceki
        </a>

        <div class="pager__nums">
          <a class="pager__num"
             th:each="i : ${#numbers.sequence(1, pageCount)}"
             th:href="@{/katalog(q=${q}, categoryId=${selectedCategoryId}, publisherId=${selectedPublisherId}, minPrice=${minPrice}, maxPrice=${maxPrice}, inStock=${inStock}, sort=${sort}, page=${i})}"
             th:text="${i}"
             th:classappend="${i == page} ? ' is-active' : ''">
            1
          </a>
        </div>

        <a class="btn btn--ghost btn--sm"
           th:classappend="${page >= pageCount} ? ' is-disabled' : ''"
           th:href="@{/katalog(q=${q}, categoryId=${selectedCategoryId}, publisherId=${selectedPublisherId}, minPrice=${minPrice}, maxPrice=${maxPrice}, inStock=${inStock}, sort=${sort}, page=${page+1})}">
          Sonraki ‚Üí
        </a>
      </nav>
    </section>
  </div>
</main>

<footer class="footer footer--light">
  <div class="container footer__inner">
    <div class="muted">¬© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> Ru≈üen Or√ßun Ko√ßer</div>
    <div class="muted">Katalog</div>
  </div>
</footer>

<!--  Index ile aynƒ± scriptler: tema butonu burada √ßalƒ±≈üƒ±r -->
<script th:src="@{/js/theme.js}" src="/js/theme.js"></script>
<script th:src="@{/js/app.js}" src="/js/app.js"></script>
<script th:src="@{/js/toast.js}" src="/js/toast.js"></script>
</body>
</html>
