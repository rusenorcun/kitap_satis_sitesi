<!doctype html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Giriş • KitapYurdu</title>
	<link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css" />
</head>

<body class="theme-light">
<header class="topbar">
	<div class="container topbar__inner">
		<a class="brand" th:href="@{/}" href="/">
			<span class="brand__mark">KY</span>
			<span class="brand__text">KitapYurdu</span>
		</a>

		<nav class="nav">
			<a class="nav__link" th:href="@{/}" href="/">Ana Sayfa</a>
			<a class="nav__link" th:href="@{/katalog}" href="/katalog">Katalog</a>
			<a class="nav__link" th:href="@{/sepet}" href="/sepet">Sepet</a>
		</nav>

		<div class="topbar__actions">
			<button class="themeToggle" type="button" data-theme-toggle aria-pressed="false">
				<span class="themeIcon">☀️</span><span class="themeText">Açık</span>
			</button>
		</div>
	</div>
</header>

<main class="container admin" style="max-width: 520px;">
	<section class="admin__head" style="margin-bottom: 10px;">
		<div>
			<h1 class="admin__title" id="pageTitle">Giriş Yap</h1>
			<p class="admin__subtitle" id="pageSubtitle">
				Hesabınla giriş yap. Admin yetkisi varsa otomatik admin panele yönlendirilirsin.
			</p>
		</div>
	</section>

	<!-- (JS kapalıysa) fallback mesaj -->
	<div class="alert" data-toast="1" th:if="${param.mesaj != null}" th:text="${param.mesaj[0]}"></div>

	<section class="card">
		<div class="card__header">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
				<div>
					<h2 class="card__title" id="cardTitle">Hesap Bilgileri</h2>
					<p class="card__desc" id="cardDesc">Kullanıcı adı ve şifreni gir.</p>
				</div>

				<!-- Sekmeler -->
				<div class="btnGroup" style="display:flex; gap:8px;">
					<button class="btn btn--ghost btn--sm" type="button" id="tabLogin" aria-pressed="true">Giriş</button>
					<button class="btn btn--ghost btn--sm" type="button" id="tabRegister" aria-pressed="false">Kayıt</button>
				</div>
			</div>
		</div>

		<div class="card__body">

			<!-- LOGIN FORM -->
			<form class="formGrid" id="loginForm" th:action="@{/login}" method="post" novalidate>
				<!-- CSRF -->
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

				<label class="field">
					<span class="field__label">Kullanıcı Adı</span>
					<input class="input" type="text" name="kullanici" autocomplete="username" required />
				</label>

				<label class="field">
					<span class="field__label">Şifre</span>
					<input class="input" type="password" name="sifre" autocomplete="current-password" required />
				</label>

				<button class="btn btn--secondary btn--block" type="submit">Giriş Yap</button>
			</form>

			<!-- REGISTER FORM (aynı sayfada) -->
			<form class="formGrid" id="registerForm" th:action="@{/auth/register}" method="post" style="display:none;" novalidate>
				<!-- CSRF -->
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

				<label class="field">
					<span class="field__label">Ad</span>
					<input class="input" type="text" name="ad" autocomplete="given-name" required />
				</label>

				<label class="field">
					<span class="field__label">Soyad</span>
					<input class="input" type="text" name="soyad" autocomplete="family-name" required />
				</label>

				<label class="field">
					<span class="field__label">Kullanıcı Adı</span>
					<input class="input" type="text" name="username" autocomplete="username" required />
				</label>

				<label class="field">
					<span class="field__label">E-posta</span>
					<input class="input" type="email" name="email" autocomplete="email" required />
				</label>

				<label class="field">
					<span class="field__label">Şifre</span>
					<input class="input" type="password" name="password" autocomplete="new-password" required />
				</label>

				<label class="field">
					<span class="field__label">Şifre (tekrar)</span>
					<input class="input" type="password" name="password2" autocomplete="new-password" required />
				</label>

				

				<label class="field">
					<span class="field__label">Telefon (opsiyonel)</span>
					<input class="input" type="tel" name="telefon" autocomplete="tel" />
				</label>

				<button class="btn btn--secondary btn--block" type="submit">Kayıt Ol</button>

				<div class="muted" style="font-size: 12.5px;">
					Kayıt olduktan sonra giriş ekranına yönlendirilirsin.
				</div>
			</form>

		</div>
	</section>
</main>

<footer class="footer footer--light">
	<div class="container footer__inner">
		<div class="muted">© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> Ruşne Orçun Koçer</div>
		<div class="muted">Giriş</div>
	</div>
</footer>

<script th:src="@{/js/toast.js}" src="/js/toast.js"></script>
<script th:src="@{/js/theme.js}" src="/js/theme.js"></script>

<script>
	(function () {
		const p = new URLSearchParams(location.search);

		// --- Sekme kontrolü ---
		const tabLogin = document.getElementById("tabLogin");
		const tabRegister = document.getElementById("tabRegister");
		const loginForm = document.getElementById("loginForm");
		const registerForm = document.getElementById("registerForm");

		const pageTitle = document.getElementById("pageTitle");
		const pageSubtitle = document.getElementById("pageSubtitle");
		const cardTitle = document.getElementById("cardTitle");
		const cardDesc = document.getElementById("cardDesc");

		function showLogin(pushUrl) {
			loginForm.style.display = "grid";
			registerForm.style.display = "none";
			tabLogin.setAttribute("aria-pressed", "true");
			tabRegister.setAttribute("aria-pressed", "false");

			pageTitle.textContent = "Giriş Yap";
			pageSubtitle.textContent = "Hesabınla giriş yap. Admin yetkisi varsa otomatik admin panele yönlendirilirsin.";
			cardTitle.textContent = "Hesap Bilgileri";
			cardDesc.textContent = "Kullanıcı adı ve şifreni gir.";

			if (pushUrl) {
				p.delete("tab");
				history.replaceState({}, "", location.pathname + (p.toString() ? ("?" + p.toString()) : ""));
			}
		}

		function showRegister(pushUrl) {
			loginForm.style.display = "none";
			registerForm.style.display = "grid";
			tabLogin.setAttribute("aria-pressed", "false");
			tabRegister.setAttribute("aria-pressed", "true");

			pageTitle.textContent = "Kayıt Ol";
			pageSubtitle.textContent = "Yeni hesap oluştur. Kayıt sonrası giriş yapabilirsin.";
			cardTitle.textContent = "Yeni Hesap";
			cardDesc.textContent = "Bilgilerini girerek hesabını oluştur.";

			if (pushUrl) {
				p.set("tab", "register");
				history.replaceState({}, "", location.pathname + "?" + p.toString());
			}
		}

		tabLogin.addEventListener("click", () => showLogin(true));
		tabRegister.addEventListener("click", () => showRegister(true));

		// URL'den başlangıç sekmesi
		if (p.get("tab") === "register") showRegister(false);
		else showLogin(false);

		// --- Toastlar (login için olanlar KALSIN) ---
		if (p.has("hata") && window.KYToast) {
			KYToast.show("Hata: Kullanıcı adı veya şifre yanlış.", "error");
			p.delete("hata");
			history.replaceState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
		}

		if (p.has("cikis") && window.KYToast) {
			KYToast.show("Çıkış yapıldı.", "success");
			p.delete("cikis");
			history.replaceState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
		}

		// --- Kayıt başarılı toast (İSTEDİĞİN) ---
		// Backend kayıt sonrası: redirect:/login?kayit=1
		if (p.has("kayit") && window.KYToast) {
			KYToast.show("Kayıt başarılı. Lütfen giriş yapınız.", "success");
			p.delete("kayit");
			// kayıt sonrası login sekmesine geçelim
			p.delete("tab");
			history.replaceState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
			showLogin(false);
		}

		// (Opsiyonel) kayıt hatası: redirect:/login?tab=register&reg_hata=1
		if (p.has("reg_hata") && window.KYToast) {
			KYToast.show("Kayıt başarısız. Lütfen bilgileri kontrol edin.", "error");
			p.delete("reg_hata");
			history.replaceState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
			showRegister(false);
		}
	})();
</script>

</body>
</html>
